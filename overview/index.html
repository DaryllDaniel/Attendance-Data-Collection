<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data Import</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papaparse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Firebase SDKs for Cloud Persistence -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services to the global scope
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            setDoc,
            doc
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .drop-area {
            border: 2px dashed #9ca3af;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        .drop-area.highlight {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div class="bg-white p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-7xl flex flex-col lg:flex-row gap-8">

        <!-- Data Import and Controls Section -->
        <div class="flex-1">
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800 mb-2">Student Data Import</h1>
            <p class="text-gray-600 mb-6">Upload a CSV file to visualize student attendance by program or department. Select a program below to view its charts.</p>
            
            <!-- File Drop Area -->
            <div id="drop-area" class="drop-area p-8 text-center cursor-pointer mb-6">
                <p class="text-gray-500 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </p>
                <p class="text-lg font-medium text-gray-600">Drag and drop a CSV file here</p>
                <span class="text-gray-400 text-sm">or click to browse</span>
                <input type="file" id="file-input" class="hidden" accept=".csv" />
            </div>

            <!-- Program Selector -->
            <div id="controls-section" class="hidden mb-6">
                <label for="program-select" class="block text-sm font-medium text-gray-700 mb-2">Select a Program:</label>
                <select id="program-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">All Departments</option>
                </select>
            </div>

            <!-- Status and Error Messages -->
            <div id="status-message" class="text-red-500 text-sm font-medium"></div>
        </div>

        <!-- Chart Section -->
        <div class="flex-1 bg-gray-50 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Live Attendance Charts</h2>
            <div id="chart-container" class="w-full h-80 flex items-center justify-center">
                <p id="chart-placeholder" class="text-gray-500 text-center">Please upload a CSV file to view the attendance charts.</p>
                <canvas id="student-chart" class="hidden"></canvas>
            </div>
        </div>

    </div>

    <script type="module">
        // --- Firebase Service Instances ---
        let db;
        let auth;
        let userId;
        const COLLECTION_NAME = "studentData";
        const DOCUMENT_ID = "mainData";

        // --- DOM Element References ---
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const programSelect = document.getElementById('program-select');
        const statusMessage = document.getElementById('status-message');
        const controlsSection = document.getElementById('controls-section');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const chartCanvas = document.getElementById('student-chart');
        
        let studentData = [];
        let myChart;

        // --- Firebase Initialization and Auth Setup ---
        const setupFirebase = async () => {
            try {
                // Use built-in Canvas variables for Firebase config and auth token
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                const app = window.firebase.initializeApp(firebaseConfig);
                auth = window.firebase.getAuth(app);
                db = window.firebase.getFirestore(app);

                // Sign in with the provided token or anonymously
                if (initialAuthToken) {
                    await window.firebase.signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await window.firebase.signInAnonymously(auth);
                }

                // Listen for auth state changes and update user ID
                window.firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Data saving happens on file drop, not on auth change.
                        statusMessage.textContent = "Cloud connection successful!";
                        statusMessage.style.color = '#10b981';
                    } else {
                        console.log("User is signed out.");
                        statusMessage.textContent = "Please sign in to save data to the cloud.";
                        statusMessage.style.color = '#dc2626';
                    }
                });
            } catch (error) {
                console.error("Firebase setup failed:", error);
                statusMessage.textContent = "Error setting up cloud connection. Please try again later.";
                statusMessage.style.color = '#dc2626';
            }
        };

        // --- Drag & Drop Event Listeners ---
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('highlight');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('highlight');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('highlight');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        dropArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        // --- File Handling and Parsing ---
        const handleFile = (file) => {
            if (file.type !== 'text/csv') {
                statusMessage.textContent = "Invalid file type. Please upload a CSV file.";
                statusMessage.style.color = '#dc2626';
                return;
            }

            statusMessage.textContent = "Processing file...";
            statusMessage.style.color = '#4b5563';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: (results) => {
                    studentData = formatData(results.data);
                    
                    if (studentData.length > 0) {
                        populateProgramSelect(studentData);
                        renderChart(studentData);
                        saveDataToFirestore(studentData);
                    } else {
                        statusMessage.textContent = "CSV file is empty or formatted incorrectly.";
                        statusMessage.style.color = '#dc2626';
                    }
                },
                error: (error) => {
                    statusMessage.textContent = "Error parsing CSV file.";
                    statusMessage.style.color = '#dc2626';
                    console.error("CSV parsing error:", error);
                }
            });
        };

        // --- Data Formatting ---
        const formatData = (data) => {
            return data.map(row => ({
                department: row.department,
                program: row.program,
                totalStudents: parseInt(row.totalStudents, 10),
                year1: { present: parseInt(row.year1_present, 10), absent: parseInt(row.year1_absent, 10) },
                year2: { present: parseInt(row.year2_present, 10), absent: parseInt(row.year2_absent, 10) },
                year3: { present: parseInt(row.year3_present, 10), absent: parseInt(row.year3_absent, 10) },
                year4: { present: parseInt(row.year4_present, 10), absent: parseInt(row.year4_absent, 10) },
            }));
        };

        // --- Save Data to Firestore ---
        const saveDataToFirestore = async (data) => {
            if (!db || !userId) {
                statusMessage.textContent = "Cloud connection not ready. Data will not be saved.";
                statusMessage.style.color = '#dc2626';
                return;
            }

            statusMessage.textContent = "Saving data to the cloud...";
            statusMessage.style.color = '#4b5563';

            // Convert the array of objects to a JSON string for single document storage
            const dataToSave = {
                studentData: JSON.stringify(data)
            };

            const docRef = window.firebase.doc(db, `artifacts/${__app_id}/users/${userId}/${COLLECTION_NAME}`, DOCUMENT_ID);

            try {
                await window.firebase.setDoc(docRef, dataToSave);
                statusMessage.textContent = "File processed and data saved to the cloud successfully!";
                statusMessage.style.color = '#10b981';
                console.log("Document successfully written with ID:", DOCUMENT_ID);
            } catch (e) {
                console.error("Error adding document: ", e);
                statusMessage.textContent = "Error saving data to the cloud. Please try again.";
                statusMessage.style.color = '#dc2626';
            }
        };

        // --- Populate Program Selector ---
        const populateProgramSelect = (data) => {
            const uniquePrograms = new Set(data.map(item => item.program));
            programSelect.innerHTML = '<option value="">All Programs</option>';
            uniquePrograms.forEach(program => {
                const option = document.createElement('option');
                option.value = program;
                option.textContent = program;
                programSelect.appendChild(option);
            });
            controlsSection.classList.remove('hidden');
        };

        // --- Chart Rendering and Updating ---
        const renderChart = (data) => {
            chartPlaceholder.classList.add('hidden');
            chartCanvas.classList.remove('hidden');

            const labels = ['1st Year', '2nd Year', '3rd Year', '4th Year'];
            const presentData = labels.map((_, i) => data.reduce((sum, current) => sum + current[`year${i + 1}`].present, 0));
            const absentData = labels.map((_, i) => data.reduce((sum, current) => sum + current[`year${i + 1}`].absent, 0));
            const totalData = labels.map((_, i) => data.reduce((sum, current) => sum + current[`year${i + 1}`].present + current[`year${i + 1}`].absent, 0));

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Present Students',
                        data: presentData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Absent Students',
                        data: absentData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Total Students',
                        data: totalData,
                        type: 'line',
                        fill: false,
                        borderColor: 'rgba(75, 85, 99, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }
                ]
            };

            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            };

            if (myChart) {
                myChart.destroy();
            }
            myChart = new Chart(chartCanvas, config);
        };

        // --- Event Listener for Program Selector ---
        programSelect.addEventListener('change', (e) => {
            const selectedProgram = e.target.value;
            let filteredData = studentData;

            if (selectedProgram !== '') {
                filteredData = studentData.filter(item => item.program === selectedProgram);
            }
            renderChart(filteredData);
        });

        // --- Initial App Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
        });
    </script>
</body>
</html>
