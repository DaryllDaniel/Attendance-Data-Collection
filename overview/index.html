<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data Import</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papaparse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Firebase SDKs for Cloud Persistence -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services to the global scope
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            setDoc,
            doc
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .drop-area {
            border: 2px dashed #9ca3af;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        .drop-area.highlight {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div class="bg-white p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-7xl flex flex-col lg:flex-row gap-8">

        <!-- Data Import and Controls Section -->
        <div class="flex-1">
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800 mb-2">Student Data Import</h1>
            <p class="text-gray-600 mb-6">Upload a CSV file to visualize student attendance by program or department. Select a program or department below to view its charts.</p>
            
            <!-- File Drop Area -->
            <div id="drop-area" class="drop-area p-8 text-center cursor-pointer mb-6">
                <p class="text-gray-500 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </p>
                <p class="text-lg font-medium text-gray-600">Drag and drop a CSV file here</p>
                <span class="text-gray-400 text-sm">or click to browse</span>
                <input type="file" id="file-input" class="hidden" accept=".csv" />
            </div>

            <!-- Program Selector -->
            <div id="program-controls-section" class="hidden mb-6">
                <label for="program-select" class="block text-sm font-medium text-gray-700 mb-2">Select a Program:</label>
                <select id="program-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">All Programs</option>
                </select>
            </div>

            <!-- Department Selector -->
            <div id="department-controls-section" class="hidden mb-6">
                <label for="department-select" class="block text-sm font-medium text-gray-700 mb-2">Select a Department:</label>
                <select id="department-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">All Departments</option>
                </select>
            </div>

            <!-- Status and Error Messages -->
            <div id="status-message" class="text-red-500 text-sm font-medium"></div>
        </div>

        <!-- Chart Section -->
        <div class="flex-1 bg-gray-50 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Attendance by Program</h2>
            <div id="program-chart-container" class="w-full h-80 flex items-center justify-center mb-6">
                <p id="program-chart-placeholder" class="text-gray-500 text-center">Please upload a CSV file to view the attendance charts.</p>
                <canvas id="program-chart" class="hidden"></canvas>
            </div>

            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Attendance by Department</h2>
            <div id="department-chart-container" class="w-full h-80 flex items-center justify-center">
                <p id="department-chart-placeholder" class="text-gray-500 text-center">Please upload a CSV file to view the attendance charts.</p>
                <canvas id="department-chart" class="hidden"></canvas>
            </div>
        </div>

    </div>

    <script type="module">
        // --- IMPORTANT: Manually paste your Firebase config here ---
        // You can get this from your Firebase project settings.
        const YOUR_FIREBASE_CONFIG = {
              apiKey: "AIzaSyDCRT5OxfwUD25pS6igy8v3xYlaGmMXK_0",
              authDomain: "event-calendar-prototype-b11b6.firebaseapp.com",
              projectId: "event-calendar-prototype-b11b6",
              storageBucket: "event-calendar-prototype-b11b6.firebasestorage.app",
              messagingSenderId: "532386656284",
              appId: "1:532386656284:web:fd4533fb0f54b198752fd9",
              measurementId: "G-J10NDCD212"
        };
        const USE_MANUAL_CONFIG = true;

        // --- Firebase Service Instances ---
        let db;
        let auth;
        let userId;
        const COLLECTION_NAME = "studentData";
        const DOCUMENT_ID = "mainData";

        // --- DOM Element References ---
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const programSelect = document.getElementById('program-select');
        const departmentSelect = document.getElementById('department-select');
        const statusMessage = document.getElementById('status-message');
        const programControlsSection = document.getElementById('program-controls-section');
        const departmentControlsSection = document.getElementById('department-controls-section');
        const programChartPlaceholder = document.getElementById('program-chart-placeholder');
        const departmentChartPlaceholder = document.getElementById('department-chart-placeholder');
        const programChartCanvas = document.getElementById('program-chart');
        const departmentChartCanvas = document.getElementById('department-chart');
        
        let studentData = [];
        let programChart;
        let departmentChart;

        // --- Firebase Initialization and Auth Setup ---
        const setupFirebase = async () => {
            try {
                // Check if running in the special environment
                const envAppId = typeof __app_id !== 'undefined' ? __app_id : null;
                const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                const envAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                let app, initialAuthToken, firebaseConfig, appId;

                if (envAppId && envFirebaseConfig && envAuthToken && !USE_MANUAL_CONFIG) {
                    // Use environment variables if available
                    appId = envAppId;
                    firebaseConfig = envFirebaseConfig;
                    initialAuthToken = envAuthToken;
                } else if (USE_MANUAL_CONFIG && YOUR_FIREBASE_CONFIG.projectId !== "YOUR_PROJECT_ID") {
                    // Use the manually provided config
                    appId = YOUR_FIREBASE_CONFIG.projectId;
                    firebaseConfig = YOUR_FIREBASE_CONFIG;
                    // For manual hosting, we'll use anonymous sign-in
                    initialAuthToken = null;
                } else {
                    // No valid configuration found
                    statusMessage.textContent = "Error: This app requires a Firebase connection. Please provide a valid configuration in the code or use the Canvas environment.";
                    statusMessage.style.color = '#dc2626';
                    return;
                }

                app = window.firebase.initializeApp(firebaseConfig);
                auth = window.firebase.getAuth(app);
                db = window.firebase.getFirestore(app);

                // Sign in with the provided custom token or anonymously
                if (initialAuthToken) {
                    await window.firebase.signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await window.firebase.signInAnonymously(auth);
                }

                window.firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        statusMessage.textContent = `Cloud connection successful! Your User ID is: ${userId}`;
                        statusMessage.style.color = '#10b981';
                    } else {
                        console.log("User is signed out.");
                        statusMessage.textContent = "Please sign in to save data to the cloud.";
                        statusMessage.style.color = '#dc2626';
                    }
                });
            } catch (error) {
                console.error("Firebase setup failed:", error);
                statusMessage.textContent = "Error setting up cloud connection. Please try again later.";
                statusMessage.style.color = '#dc2626';
            }
        };

        // --- Drag & Drop Event Listeners ---
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('highlight');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('highlight');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('highlight');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        dropArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        // --- File Handling and Parsing ---
        const handleFile = (file) => {
            if (file.type !== 'text/csv') {
                statusMessage.textContent = "Invalid file type. Please upload a CSV file.";
                statusMessage.style.color = '#dc2626';
                return;
            }

            statusMessage.textContent = "Processing file...";
            statusMessage.style.color = '#4b5563';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: (results) => {
                    studentData = formatData(results.data);
                    
                    if (studentData.length > 0) {
                        populateSelectors(studentData);
                        renderProgramChart(studentData);
                        renderDepartmentChart(studentData);
                        saveDataToFirestore(studentData);
                    } else {
                        statusMessage.textContent = "CSV file is empty or formatted incorrectly.";
                        statusMessage.style.color = '#dc2626';
                    }
                },
                error: (error) => {
                    statusMessage.textContent = "Error parsing CSV file.";
                    statusMessage.style.color = '#dc2626';
                    console.error("CSV parsing error:", error);
                }
            });
        };

        // --- Data Formatting ---
        const formatData = (data) => {
            return data.map(row => ({
                department: row.Department,
                program: row.Program,
                year1: { present: parseInt(row['1st Year Present'], 10), absent: parseInt(row['1st Year Absent'], 10) },
                year2: { present: parseInt(row['2nd Year Present'], 10), absent: parseInt(row['2nd Year Absent'], 10) },
                year3: { present: parseInt(row['3rd Year Present'], 10), absent: parseInt(row['3rd Year Absent'], 10) },
                year4: { present: parseInt(row['4th Year Present'], 10), absent: parseInt(row['4th Year Absent'], 10) },
            }));
        };

        // --- Save Data to Firestore ---
        const saveDataToFirestore = async (data) => {
            if (!db || !userId) {
                statusMessage.textContent = "Cloud connection not ready. Data will not be saved.";
                statusMessage.style.color = '#dc2626';
                return;
            }

            statusMessage.textContent = "Saving data to the cloud...";
            statusMessage.style.color = '#4b5563';

            const dataToSave = {
                studentData: JSON.stringify(data)
            };

            // Use the correct path based on whether it's in a special environment or self-hosted
            const docPath = typeof __app_id !== 'undefined' 
                ? `artifacts/${__app_id}/users/${userId}/${COLLECTION_NAME}`
                : `artifacts/${YOUR_FIREBASE_CONFIG.projectId}/users/${userId}/${COLLECTION_NAME}`;

            const docRef = window.firebase.doc(db, docPath, DOCUMENT_ID);

            try {
                await window.firebase.setDoc(docRef, dataToSave);
                statusMessage.textContent = "File processed and data saved to the cloud successfully!";
                statusMessage.style.color = '#10b981';
                console.log("Document successfully written with ID:", DOCUMENT_ID);
            } catch (e) {
                console.error("Error adding document: ", e);
                statusMessage.textContent = "Error saving data to the cloud. Please try again.";
                statusMessage.style.color = '#dc2626';
            }
        };

        // --- Populate Selectors ---
        const populateSelectors = (data) => {
            const uniquePrograms = new Set(data.map(item => item.program));
            programSelect.innerHTML = '<option value="">All Programs</option>';
            uniquePrograms.forEach(program => {
                const option = document.createElement('option');
                option.value = program;
                option.textContent = program;
                programSelect.appendChild(option);
            });
            programControlsSection.classList.remove('hidden');

            const uniqueDepartments = new Set(data.map(item => item.department));
            departmentSelect.innerHTML = '<option value="">All Departments</option>';
            uniqueDepartments.forEach(department => {
                const option = document.createElement('option');
                option.value = department;
                option.textContent = department;
                departmentSelect.appendChild(option);
            });
            departmentControlsSection.classList.remove('hidden');
        };

        // --- Program Chart Rendering and Updating ---
        const renderProgramChart = (data) => {
            programChartPlaceholder.classList.add('hidden');
            programChartCanvas.classList.remove('hidden');

            const labels = ['1st Year', '2nd Year', '3rd Year', '4th Year'];
            const presentData = labels.map((_, i) => data.reduce((sum, current) => sum + current[`year${i + 1}`].present, 0));
            const absentData = labels.map((_, i) => data.reduce((sum, current) => sum + current[`year${i + 1}`].absent, 0));

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Present Students',
                        data: presentData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Absent Students',
                        data: absentData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }
                ]
            };

            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const value = context.raw;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : '0.00';
                                    return `${context.dataset.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            };

            if (programChart) {
                programChart.destroy();
            }
            programChart = new Chart(programChartCanvas, config);
        };

        // --- Department Chart Rendering and Updating (Bar Chart) ---
        const renderDepartmentChart = (data) => {
            departmentChartPlaceholder.classList.add('hidden');
            departmentChartCanvas.classList.remove('hidden');

            const departmentData = data.reduce((acc, row) => {
                if (!acc[row.department]) {
                    acc[row.department] = { present: 0, absent: 0 };
                }
                acc[row.department].present += row.year1.present + row.year2.present + row.year3.present + row.year4.present;
                acc[row.department].absent += row.year1.absent + row.year2.absent + row.year3.absent + row.year4.absent;
                return acc;
            }, {});

            const labels = Object.keys(departmentData);
            const presentData = labels.map(label => departmentData[label].present);
            const absentData = labels.map(label => departmentData[label].absent);

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Present Students',
                        data: presentData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Absent Students',
                        data: absentData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }
                ]
            };

            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const value = context.raw;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : '0.00';
                                    return `${context.dataset.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            };

            if (departmentChart) {
                departmentChart.destroy();
            }
            departmentChart = new Chart(departmentChartCanvas, config);
        };

        // --- Event Listeners for Selectors ---
        programSelect.addEventListener('change', (e) => {
            const selectedProgram = e.target.value;
            let filteredData = studentData;

            if (selectedProgram !== '') {
                filteredData = studentData.filter(item => item.program === selectedProgram);
            }
            renderProgramChart(filteredData);
        });

        departmentSelect.addEventListener('change', (e) => {
            const selectedDepartment = e.target.value;
            let filteredData = studentData;

            if (selectedDepartment !== '') {
                filteredData = studentData.filter(item => item.department === selectedDepartment);
            }
            renderDepartmentChart(filteredData);
        });

        // --- Initial App Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
        });
    </script>
</body>
</html>
