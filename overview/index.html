<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for creating the pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .program-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        .program-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .program-item.active {
            background-color: #2563eb;
            color: #ffffff;
            font-weight: bold;
        }
        .program-item.active h3, .program-item.active p {
            color: #ffffff;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div class="bg-white p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-7xl flex flex-col md:flex-row gap-8">

        <!-- Left Side: Import and Program List -->
        <div class="w-full md:w-1/2 space-y-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center md:text-left text-blue-800 mb-6">Student Data Import</h1>
            <p class="text-center md:text-left text-gray-600 mb-8">Upload a CSV file to visualize student attendance by program or department. Select a program below to view its charts.</p>

            <!-- File Import Area -->
            <div class="space-y-4">
                <div class="p-6 border-2 border-dashed border-gray-300 rounded-lg text-center bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer">
                    <label for="csvFile" class="flex flex-col items-center justify-center space-y-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        <span class="font-semibold text-gray-600">Drag and drop a CSV file here</span>
                        <span class="text-sm text-gray-500">or click to browse</span>
                        <input type="file" id="csvFile" class="hidden" accept=".csv">
                    </label>
                </div>
                <div id="statusMessage" class="text-center text-sm font-medium text-gray-600"></div>
            </div>

            <!-- Program List -->
            <div id="programListContainer" class="hidden mt-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Select a Program</h2>
                <div id="programList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    <!-- Program items will be dynamically added here -->
                </div>
            </div>

            <!-- Export Button -->
            <div class="mt-8 flex justify-center">
                <button id="exportCsvBtn" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 font-bold">Export All Data to CSV</button>
            </div>
        </div>

        <!-- Right Side: Real-time Chart Display Section -->
        <div class="w-full md:w-1/2 flex flex-col justify-center items-center p-4 bg-gray-50 rounded-xl shadow-inner">
            <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-4">Live Attendance Charts</h2>
            
            <div id="noDataMessage" class="text-center text-gray-500 mt-8">
                Please upload a CSV file to view the attendance charts.
            </div>

            <div id="chartContainer" class="hidden w-full max-w-xl space-y-6">
                <!-- Overall Chart -->
                <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center">
                    <h3 class="font-semibold text-center text-lg mb-2 text-gray-700">Overall Attendance</h3>
                    <div class="w-full h-auto max-w-xs mx-auto">
                        <canvas id="myPieChart"></canvas>
                    </div>
                </div>

                <!-- Department Distribution Chart -->
                <div id="departmentDistributionChartContainer" class="hidden p-4 bg-white rounded-lg shadow-md flex flex-col items-center">
                    <h3 class="font-semibold text-center text-lg mb-2 text-gray-700">Department Distribution</h3>
                    <div class="w-full h-auto max-w-[250px] mx-auto">
                        <canvas id="departmentDistributionChart"></canvas>
                    </div>
                </div>

                <!-- New Program Distribution Chart with Slider -->
                <div id="programDistributionSection" class="hidden p-4 bg-white rounded-lg shadow-md flex flex-col items-center">
                    <h3 class="font-semibold text-center text-lg mb-2 text-gray-700">Program Distribution by Department</h3>
                    <div class="w-full max-w-[300px] mb-4">
                        <label id="selectedDepartmentLabel" class="font-bold text-blue-600 text-center block mb-2">Select a Department</label>
                        <input type="range" id="departmentSlider" min="0" max="0" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="w-full h-auto max-w-[250px] mx-auto">
                        <canvas id="programDistributionChart"></canvas>
                    </div>
                </div>
                
                <!-- Individual Year Charts -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 w-full">
                    <!-- 1st Year Chart -->
                    <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center">
                        <h3 class="font-semibold text-center text-lg mb-2 text-blue-600">1st Year</h3>
                        <div class="w-full h-auto max-w-[150px] mx-auto">
                            <canvas id="year1PieChart"></canvas>
                        </div>
                    </div>
                    <!-- 2nd Year Chart -->
                    <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center">
                        <h3 class="font-semibold text-center text-lg mb-2 text-green-600">2nd Year</h3>
                        <div class="w-full h-auto max-w-[150px] mx-auto">
                            <canvas id="year2PieChart"></canvas>
                        </div>
                    </div>
                    <!-- 3rd Year Chart -->
                    <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center">
                        <h3 class="font-semibold text-center text-lg mb-2 text-yellow-600">3rd Year</h3>
                        <div class="w-full h-auto max-w-[150px] mx-auto">
                            <canvas id="year3PieChart"></canvas>
                        </div>
                    </div>
                    <!-- 4th Year Chart -->
                    <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center">
                        <h3 class="font-semibold text-center text-lg mb-2 text-purple-600">4th Year</h3>
                        <div class="w-full h-auto max-w-[150px] mx-auto">
                            <canvas id="year4PieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const csvFile = document.getElementById('csvFile');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const statusMessage = document.getElementById('statusMessage');
        const noDataMessage = document.getElementById('noDataMessage');
        const chartContainer = document.getElementById('chartContainer');
        const departmentDistributionChartContainer = document.getElementById('departmentDistributionChartContainer');
        const programList = document.getElementById('programList');
        const programListContainer = document.getElementById('programListContainer');
        const programDistributionSection = document.getElementById('programDistributionSection');
        const departmentSlider = document.getElementById('departmentSlider');
        const selectedDepartmentLabel = document.getElementById('selectedDepartmentLabel');
        const chartInstances = {}; // Object to store all chart instances
        let studentDataList = []; // Variable to hold the parsed data for all programs
        let departments = {}; // Object to hold aggregated data by department
        let departmentNames = []; // Array to hold unique department names for the slider

        // --- Helper function to create/update a pie chart ---
        const updatePieChart = (canvasId, data, labels, colors, tooltipLabels = labels) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas element with ID '${canvasId}' not found.`);
                return;
            }

            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }

            const chart = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 8,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const value = tooltipItem.raw;
                                    const total = tooltipItem.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                    // Use a custom label for the tooltip to show the full name
                                    return ` ${tooltipItem.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '40%',
                }
            });

            chartInstances[canvasId] = chart;
        };
        
        // --- Function to update the overall attendance charts ---
        const updateAttendanceCharts = (data) => {
            if (!data) return;
            const totalPresent = data.year1.present + data.year2.present + data.year3.present + data.year4.present;
            const totalAbsent = data.year1.absent + data.year2.absent + data.year3.absent + data.year4.absent;
            updatePieChart('myPieChart', [totalPresent, totalAbsent], ['Present', 'Absent'], ['#2563eb', '#dc2626']);
            updatePieChart('year1PieChart', [data.year1.present, data.year1.absent], ['Present', 'Absent'], ['#2563eb', '#dc2626']);
            updatePieChart('year2PieChart', [data.year2.present, data.year2.absent], ['Present', 'Absent'], ['#2563eb', '#dc2626']);
            updatePieChart('year3PieChart', [data.year3.present, data.year3.absent], ['Present', 'Absent'], ['#2563eb', '#dc2626']);
            updatePieChart('year4PieChart', [data.year4.present, data.year4.absent], ['Present', 'Absent'], ['#2563eb', '#dc2626']);
        };
        
        // --- Function to update the department distribution chart ---
        const updateDepartmentCharts = () => {
            departmentNames = Object.keys(departments);
            const departmentData = departmentNames.map(dept => departments[dept].totalStudents);
            const departmentColors = departmentNames.map((_, i) => `hsl(${i * 360 / departmentNames.length}, 70%, 50%)`);

            if (departmentNames.length > 1) {
                departmentDistributionChartContainer.classList.remove('hidden');
                
                // Calculate total students to get percentages
                const totalStudents = departmentData.reduce((sum, current) => sum + current, 0);

                // Create new labels with name, count, and percentage
                const newLabels = departmentNames.map((name, index) => {
                    const count = departmentData[index];
                    const percentage = totalStudents > 0 ? ((count / totalStudents) * 100).toFixed(1) : 0;
                    return `${name}: ${count} (${percentage}%)`;
                });

                updatePieChart('departmentDistributionChart', departmentData, newLabels, departmentColors);
            } else {
                departmentDistributionChartContainer.classList.add('hidden');
            }
        };

        // --- Function to update the program distribution chart for a specific department ---
        const updateProgramDistributionChart = (departmentName) => {
            const programsInDept = studentDataList.filter(p => p.department === departmentName);
            const programLabels = programsInDept.map(p => p.program);
            const programData = programsInDept.map(p => p.totalStudents);
            const programColors = programLabels.map((_, i) => `hsl(${i * 360 / programLabels.length}, 70%, 50%)`);
            
            programDistributionSection.classList.remove('hidden');
            updatePieChart('programDistributionChart', programData, programLabels, programColors);
        };
        
        // --- Render Program List ---
        const renderProgramList = (dataList) => {
            programList.innerHTML = '';
            dataList.forEach((data, index) => {
                const programDiv = document.createElement('div');
                programDiv.classList.add('program-item', 'p-4', 'bg-white', 'rounded-lg', 'shadow-md');
                programDiv.innerHTML = `
                    <h3 class="font-semibold text-gray-800">${data.program}</h3>
                    <p class="text-sm text-gray-600">${data.department}</p>
                `;
                programDiv.dataset.index = index;
                programDiv.addEventListener('click', () => {
                    const isActive = programDiv.classList.contains('active');
                    
                    document.querySelectorAll('.program-item').forEach(item => item.classList.remove('active'));

                    if (isActive) {
                        // If it was already active, deselect it
                        noDataMessage.textContent = 'Please select a program to view detailed attendance charts.';
                        chartContainer.classList.add('hidden');
                        noDataMessage.classList.remove('hidden');
                    } else {
                        // If it was not active, select it
                        programDiv.classList.add('active');
                        updateAttendanceCharts(studentDataList[index]);
                        noDataMessage.classList.add('hidden');
                        chartContainer.classList.remove('hidden');
                    }
                });
                programList.appendChild(programDiv);
            });
            programListContainer.classList.remove('hidden');
        };

        // --- Handle Slider Input ---
        const handleSliderInput = () => {
            const index = departmentSlider.value;
            const selectedDepartment = departmentNames[index];
            if (selectedDepartment) {
                selectedDepartmentLabel.textContent = selectedDepartment;
                updateProgramDistributionChart(selectedDepartment);
            }
        };

        // --- Parse CSV File ---
        const parseCsv = (csvText) => {
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                statusMessage.textContent = 'Error: CSV file must contain a header and at least one data row.';
                statusMessage.style.color = '#dc2626';
                return null;
            }

            const headers = lines[0].split(',').map(h => h.trim());
            const dataRows = lines.slice(1);
            const parsedData = [];

            if (headers.length !== 14) {
                statusMessage.textContent = 'Error: CSV format is incorrect. Expected 14 columns.';
                statusMessage.style.color = '#dc2626';
                return null;
            }
            
            for (const row of dataRows) {
                const values = row.split(',').map(v => v.trim());
                if (values.length !== 14) {
                    statusMessage.textContent = `Error: Row has an incorrect number of columns. Expected 14, got ${values.length}.`;
                    statusMessage.style.color = '#dc2626';
                    return null;
                }
                
                try {
                    const year1Total = parseInt(values[2]);
                    const year2Total = parseInt(values[5]);
                    const year3Total = parseInt(values[8]);
                    const year4Total = parseInt(values[11]);
                    const totalStudents = year1Total + year2Total + year3Total + year4Total;

                    parsedData.push({
                        department: values[0],
                        program: values[1],
                        year1: { total: year1Total, present: parseInt(values[3]), absent: parseInt(values[4]) },
                        year2: { total: year2Total, present: parseInt(values[6]), absent: parseInt(values[7]) },
                        year3: { total: year3Total, present: parseInt(values[9]), absent: parseInt(values[10]) },
                        year4: { total: year4Total, present: parseInt(values[12]), absent: parseInt(values[13]) },
                        totalStudents: totalStudents
                    });
                } catch (e) {
                    statusMessage.textContent = 'Error: Failed to parse data. Please ensure number columns contain valid numbers.';
                    statusMessage.style.color = '#dc2626';
                    return null;
                }
            }
            
            return parsedData;
        };

        // --- Handle File Upload ---
        const handleFileLoad = (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            statusMessage.textContent = 'Reading file...';
            statusMessage.style.color = '#4b5563';

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                studentDataList = parseCsv(text);
                
                if (studentDataList && studentDataList.length > 0) {
                    // Aggregate data by department
                    departments = studentDataList.reduce((acc, current) => {
                        if (!acc[current.department]) {
                            acc[current.department] = { totalStudents: 0, programs: [] };
                        }
                        acc[current.department].totalStudents += current.totalStudents;
                        acc[current.department].programs.push(current);
                        return acc;
                    }, {});

                    statusMessage.textContent = `File "${file.name}" loaded successfully. Found ${studentDataList.length} programs.`;
                    statusMessage.style.color = '#10b981';
                    
                    renderProgramList(studentDataList);
                    updateDepartmentCharts();
                    
                    noDataMessage.classList.add('hidden');
                    chartContainer.classList.remove('hidden');

                    // Select the first program and show its charts
                    const firstProgramItem = document.querySelector('.program-item');
                    if(firstProgramItem) {
                        firstProgramItem.classList.add('active');
                        updateAttendanceCharts(studentDataList[0]);
                    }

                    // Initialize the department slider
                    departmentNames = Object.keys(departments);
                    departmentSlider.max = departmentNames.length - 1;
                    if (departmentNames.length > 0) {
                        departmentSlider.value = 0;
                        selectedDepartmentLabel.textContent = departmentNames[0];
                        updateProgramDistributionChart(departmentNames[0]);
                        programDistributionSection.classList.remove('hidden');
                    }
                } else if (studentDataList) {
                    statusMessage.textContent = 'File loaded, but no program data was found.';
                    statusMessage.style.color = '#dc2626';
                    studentDataList = [];
                    programListContainer.classList.add('hidden');
                    noDataMessage.textContent = 'Please upload a CSV file to view the attendance charts.';
                    noDataMessage.classList.remove('hidden');
                    chartContainer.classList.add('hidden');
                    updateDepartmentCharts();
                    programDistributionSection.classList.add('hidden');
                }
            };
            reader.readAsText(file);
        };

        // --- Export to CSV Functionality ---
        const exportToCsv = () => {
            if (studentDataList.length === 0) {
                const messageBox = document.createElement('div');
                messageBox.textContent = 'No data to export. Please import a file first.';
                messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;';
                document.body.appendChild(messageBox);
                setTimeout(() => document.body.removeChild(messageBox), 3000);
                return;
            }

            const headers = [
                'Department', 'Program',
                '1st Year Total', '1st Year Present', '1st Year Absent',
                '2nd Year Total', '2nd Year Present', '2nd Year Absent',
                '3rd Year Total', '3rd Year Present', '3rd Year Absent',
                '4th Year Total', '4th Year Present', '4th Year Absent'
            ];
            
            const csvRows = studentDataList.map(data => {
                return [
                    data.department || 'N/A', data.program || 'N/A',
                    data.year1.total, data.year1.present, data.year1.absent,
                    data.year2.total, data.year2.present, data.year2.absent,
                    data.year3.total, data.year3.present, data.year3.absent,
                    data.year4.total, data.year4.present, data.year4.absent
                ].join(',');
            });

            const csvContent = headers.join(',') + '\n' + csvRows.join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'student_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                const messageBox = document.createElement('div');
                messageBox.textContent = 'Your browser does not support downloading CSV files directly.';
                messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;';
                document.body.appendChild(messageBox);
                setTimeout(() => document.body.removeChild(messageBox), 3000);
            }
        };

        // --- Event Listeners ---
        csvFile.addEventListener('change', handleFileLoad);
        exportCsvBtn.addEventListener('click', exportToCsv);
        departmentSlider.addEventListener('input', handleSliderInput);

        // Initial state on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateAttendanceCharts(null);
            updateDepartmentCharts();
        });
    </script>
</body>
</html>
