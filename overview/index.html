<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Calendar Uploader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase services to the global scope
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            getFirestore,
            doc,
            setDoc
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            background-image: url('https://scontent.fcrk1-1.fna.fbcdn.net/v/t39.30808-6/534829113_1219906786818614_3623306942044619088_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=833d8c&_nc_ohc=IVr9Yr1-pvUQkNvwFa9iO5&_nc_oc=AdntxIkfqY4bkAXBlJJlzddtb7L6hdtB7b9Szq2OuBkDf7fySj9CgdnctopvIdlkE_aA&_nc_zt=23&_nc_ht=scontent.fcrk1-1.fna&_nc_gid=wsNnun-HKCpyMJFkIDXHpA&oh=00_AfUlrYAo7YO63AptckNh1w5AiCyZbvdvxxE5l_uo6vsQw&oe=68AF8B73');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 255, 0.3);
            z-index: 1;
        }

        /* Styles for the modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 20px;
        }

        #top-left-logo {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 10;
            width: 100px;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 640px) {
            #top-left-logo {
                width: 80px;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">
    <img id="top-left-logo" src="https://scontent.fcrk1-4.fna.fbcdn.net/v/t39.30808-6/537430317_122096293532993050_6396531567539471614_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=WSX_ci11nyQQ7kNvwEt-pXT&_nc_oc=Adn4_s5UW7ucupcP6SwXVA6JsI0fFG59JlUg4Fl-oZixJ3AvkBxrOUTP9DBFT9lC0dY&_nc_zt=23&_nc_ht=scontent.fcrk1-4.fna&_nc_gid=KnzKC5VvxRFOiRXB42TeGA&oh=00_AfWzidd9JfjRRoaZAQigWK_JOqp-X-Ccys0BnucXvXIPaQ&oe=68AFA576" alt="Logo">

    <div class="text-center mb-8 px-4 z-20">
        <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-2 drop-shadow-lg">Event Data Uploader</h1>
        <p class="text-gray-200 drop-shadow-md">Upload student data to the cloud.</p>
    </div>

    <div class="bg-white bg-opacity-80 p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-7xl flex flex-col gap-8 z-20">
        <div class="flex-1">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Upload CSV Data</h2>
            <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-6">
                <input type="text" id="event-name-input" placeholder="Enter Event Name" class="w-full md:w-1/2 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" />
                <input type="file" id="file-input" class="w-full md:w-1/2 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" accept=".csv" />
            </div>
            <div class="flex justify-center">
                <button id="upload-button" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105">
                    Upload
                </button>
            </div>
        </div>

        <!-- Status Message -->
        <div id="status-message" class="text-center p-4 text-gray-500 font-medium bg-gray-100 rounded-lg hidden">
            Awaiting file selection...
        </div>
    </div>

    <!-- The custom modal for alerts -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-700 mb-4"></p>
            <div class="modal-buttons">
                <button id="modal-ok-button" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-all duration-200">OK</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // --- Firebase Service Instances ---
        let db;
        let auth;
        const EVENTS_COLLECTION_NAME = "event_attendance_tracker";
        const FIREBASE_PROJECT_ID = "event-calendar-prototype-b11b6";

        // This is the new public data path that everyone can access after authentication.
        const PUBLIC_DATA_PATH = `artifacts/${FIREBASE_PROJECT_ID}/public/data/${EVENTS_COLLECTION_NAME}`;

        // --- DOM Element References ---
        const eventNameInput = document.getElementById('event-name-input');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const statusMessage = document.getElementById('status-message');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkButton = document.getElementById('modal-ok-button');

        // --- Event Listeners ---
        uploadButton.addEventListener('click', () => uploadData());
        modalOkButton.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // --- Firebase Initialization and Auth Setup ---
        const setupFirebase = async () => {
            try {
                // Use the Firebase configuration provided by the user.
                const firebaseConfig = {
                    apiKey: "AIzaSyDCRT5OxfwUD25pS6igy8v3xYlaGmMXK_0",
                    authDomain: "event-calendar-prototype-b11b6.firebaseapp.com",
                    projectId: "event-calendar-prototype-b11b6",
                    storageBucket: "event-calendar-prototype-b11b6.firebasestorage.app",
                    messagingSenderId: "532386656284",
                    appId: "1:532386656284:web:fd4533fb0f54b198752fd9",
                    measurementId: "G-J10NDCD212"
                };

                const app = window.firebase.initializeApp(firebaseConfig);
                auth = window.firebase.getAuth(app);
                db = window.firebase.getFirestore(app);

                // Sign in anonymously. This is required to access the public collection.
                await window.firebase.signInAnonymously(auth);

                statusMessage.textContent = "Connected to the cloud. Ready to upload.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('bg-gray-100', 'text-gray-500');
            } catch (error) {
                console.error("Firebase setup failed:", error);
                showModal("Setup Error", `Error setting up cloud connection: ${error.message}`);
                statusMessage.textContent = "Error setting up cloud connection. Please try again later.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.remove('text-gray-500', 'bg-gray-100');
                statusMessage.classList.add('text-red-600', 'bg-red-100');
            }
        };

        // --- Data Upload Function ---
        const uploadData = async () => {
            const eventName = eventNameInput.value.trim();
            const file = fileInput.files[0];

            if (!eventName) {
                showModal("Validation Error", "Please enter an event name.");
                return;
            }
            if (!file) {
                showModal("Validation Error", "Please select a CSV file to upload.");
                return;
            }

            statusMessage.textContent = "Uploading...";
            statusMessage.classList.remove('hidden', 'bg-red-100', 'bg-green-100');
            statusMessage.classList.add('bg-gray-100', 'text-gray-500');

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const csvText = e.target.result;
                    const parsedData = parseCsv(csvText);
                    
                    if (parsedData.length === 0) {
                        showModal("Upload Error", "The CSV file is empty.");
                        statusMessage.textContent = "Upload failed!";
                        return;
                    }

                    // Now we save to the new public path
                    const docRef = window.firebase.doc(db, PUBLIC_DATA_PATH, eventName);
                    
                    await window.firebase.setDoc(docRef, {
                        data: JSON.stringify(parsedData)
                    });

                    statusMessage.textContent = "Upload successful! Data is now available to be viewed.";
                    statusMessage.classList.remove('bg-gray-100', 'text-gray-500');
                    statusMessage.classList.add('bg-green-100', 'text-green-600');
                    eventNameInput.value = '';
                    fileInput.value = '';
                };
                reader.onerror = () => {
                    showModal("File Read Error", "Failed to read the file.");
                    statusMessage.textContent = "Upload failed!";
                };
                reader.readAsText(file);
            } catch (e) {
                console.error("Error during upload: ", e);
                showModal("Upload Failed", `An error occurred: ${e.message}`);
                statusMessage.textContent = "Upload failed!";
                statusMessage.classList.remove('bg-gray-100', 'text-gray-500');
                statusMessage.classList.add('bg-red-100', 'text-red-600');
            }
        };

        // --- CSV Parsing Function ---
        const parseCsv = (text) => {
            const rows = text.split('\n').filter(row => row.trim() !== '');
            return rows.map(row => row.split(',').map(cell => cell.trim()));
        };

        // --- Custom Modal Function ---
        const showModal = (title, message) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.style.display = 'flex';
        };

        // Initialize Firebase on page load
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
        });
    </script>
</body>
</html>
