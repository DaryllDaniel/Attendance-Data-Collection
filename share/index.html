<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data Viewer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs for Cloud Persistence -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services to the global scope
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            getFirestore,
            doc,
            onSnapshot,
            collection,
            getDocs
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            background-image: url('https://scontent.fcrk1-1.fna.fbcdn.net/v/t39.30808-6/534829113_1219906786818614_3623306942044619088_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=833d8c&_nc_ohc=IVr9Yr1-pvUQkNvwFa9iO5&_nc_oc=AdntxIkfqY4bkAXBlJJlzddtb7L6hdtB7b9Szq2OuBkDf7fySj9CjncTopvIdlkE_aA&_nc_zt=23&_nc_ht=scontent.fcrk1-1.fna&_nc_gid=wsNnun-HKCpyMJFkIDXHpA&oh=00_AfUlrYAo7YO63AptckNhX1w5AiCyZbvdvxxE5l_uo6vsQw&oe=68AF8B73');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 255, 0.3);
            z-index: 1;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        #top-left-logo {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 10;
            width: 100px;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Styles for the new event selector dropdown */
        .event-selector-container {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        #event-selector {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            background-color: #fff;
            color: #374151;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-height: 180px; /* Adjust based on desired number of visible options (approx 5) */
            overflow-y: auto;
        }
        
        #event-selector option {
            padding: 0.5rem;
        }

        @media (min-width: 640px) {
            .event-selector-container {
                flex-direction: row;
                align-items: center;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <!-- Top-left logo -->
    <img id="top-left-logo" src="https://scontent.fcrk1-2.fna.fbcdn.net/v/t39.30808-6/481256091_1075839891225305_8701060058928039111_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=OCjjkE8jx7IQ7kNvwEp79Cp&_nc_oc=AdnDPmGq-xwFdLhQcze1O-nZmR0e5Nr8AX3fDmfdOLUP-d_29Lg7J65H2Q8TE5sY-4&_nc_zt=23&_nc_ht=scontent.fcrk1-2.fna&_nc_gid=nFjzVEKrI6WrhINW3zz39w&oh=00_AfVGG0LH9XXR_Q2o-1bm8ODj0HrJU7A7o6eu4L5YYjY7Cw&oe=68AFB084" alt="Logo">

    <!-- New Event Selector Dropdown -->
    <div class="event-selector-container">
        <label for="event-selector" class="text-white font-medium text-sm drop-shadow-md">Load an Event:</label>
        <select id="event-selector">
            <option value="">Loading events...</option>
        </select>
    </div>

    <!-- Separate div for title and description -->
    <div class="text-center mb-8 px-4 z-20">
        <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-2 drop-shadow-lg">Student Data Viewer</h1>
        <p class="text-gray-200 drop-shadow-md">Data retrieved successfully!</p>
    </div>

    <!-- Main Application Container -->
    <div class="bg-white bg-opacity-80 p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-7xl flex flex-col gap-8 z-20 overflow-auto">

        <!-- Data Display and Controls Section -->
        <div class="flex-1">
            <!-- Loading and Status Messages -->
            <div id="status-message" class="text-center p-4 text-gray-500 font-medium bg-gray-100 rounded-lg mb-6 hidden">
                Connecting to the cloud...
            </div>
        </div>

        <!-- Chart Section -->
        <div class="flex-1 bg-gray-50 bg-opacity-90 p-6 rounded-xl shadow-inner w-full">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 text-center">Department and Program Attendance</h2>
            
            <!-- Overall Attendance Bar Chart -->
            <div class="p-4 bg-white bg-opacity-90 rounded-lg shadow-md mb-6 w-full">
                <h3 class="font-semibold text-center text-lg mb-2 text-gray-700">Overall Attendance Summary</h3>
                <div class="chart-container">
                    <canvas id="overall-bar-chart"></canvas>
                </div>
            </div>

            <!-- Department Slider and Charts Container -->
            <div class="my-8">
                <h3 class="text-xl md:text-2xl font-bold text-gray-700 mb-4 text-center">Department and Program Details</h3>
                
                <!-- Department Slider -->
                <div class="flex flex-col items-center mb-6">
                    <label for="department-slider" class="block text-lg font-medium text-gray-700 mb-2">Select a Department:</label>
                    <div class="w-full max-w-xl flex items-center justify-between gap-4">
                        <input type="range" id="department-slider" min="0" max="0" step="1" value="0" class="w-full">
                        <span id="department-name" class="text-base font-medium text-gray-800 min-w-[150px] text-right">Loading...</span>
                    </div>
                </div>

                <div id="department-program-bar-charts-container" class="grid grid-cols-1 gap-6 w-full h-auto">
                    <!-- The selected department's chart will be rendered here -->
                    <p id="charts-placeholder" class="text-gray-500 text-center col-span-full">Please select a department to view details.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Service Instances ---
        let db;
        let auth;
        // The collection path is now constructed to match your security rules
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const EVENTS_COLLECTION_PATH = `artifacts/${appId}/public/data/events`;

        // --- DOM Element References ---
        const statusMessage = document.getElementById('status-message');
        const departmentProgramBarChartsContainer = document.getElementById('department-program-bar-charts-container');
        const chartsPlaceholder = document.getElementById('charts-placeholder');
        const departmentSlider = document.getElementById('department-slider');
        const departmentNameSpan = document.getElementById('department-name');
        const eventSelector = document.getElementById('event-selector');

        let studentData = [];
        let departments = []; // Store the list of departments
        let overallBarChartInstance = null; // Instance for the overall bar chart
        let currentDepartmentCharts = []; // Array to store chart instances for the slider view

        // --- Firebase Initialization and Auth Setup ---
        const setupFirebase = () => {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyDCRT5OxfwUD25pS6igy8v3xYlaGmMXK_0",
                    authDomain: "event-calendar-prototype-b11b6.firebaseapp.com",
                    projectId: "event-calendar-prototype-b11b6",
                    storageBucket: "event-calendar-prototype-b11b6.firebasestorage.app",
                    messagingSenderId: "532386656284",
                    appId: "1:532386656284:web:fd4533fb0f54b198752fd9",
                    measurementId: "G-J10NDCD212"
                };

                const app = window.firebase.initializeApp(firebaseConfig);
                auth = window.firebase.getAuth(app);
                db = window.firebase.getFirestore(app);

                window.firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        statusMessage.textContent = "Connected to the cloud. Loading events...";
                        statusMessage.classList.remove('hidden');
                        statusMessage.classList.add('bg-gray-100', 'text-gray-500');
                        fetchEventsAndInitialData();
                    } else {
                        await window.firebase.signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase setup failed:", error);
                statusMessage.textContent = "Error setting up cloud connection. Please try again later.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.remove('text-gray-500', 'bg-gray-100');
                statusMessage.classList.add('text-red-600', 'bg-red-100');
            }
        };

        // --- Fetch List of Events from Firestore ---
        const fetchEventsAndInitialData = async () => {
            if (!db) {
                statusMessage.textContent = "Cloud connection not ready. Events cannot be retrieved.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('text-red-600', 'bg-red-100');
                return;
            }

            try {
                // The collection reference now points to the full path.
                const eventsRef = window.firebase.collection(db, EVENTS_COLLECTION_PATH);
                const querySnapshot = await window.firebase.getDocs(eventsRef);

                const eventNames = querySnapshot.docs.map(doc => doc.id);
                
                eventSelector.innerHTML = '';
                if (eventNames.length > 0) {
                    eventNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        eventSelector.appendChild(option);
                    });
                    eventSelector.value = eventNames[0];
                    loadAndRenderData(eventNames[0]);
                } else {
                    const option = document.createElement('option');
                    option.textContent = "No events found";
                    option.value = "";
                    eventSelector.appendChild(option);
                    statusMessage.textContent = "No events found in the cloud.";
                    statusMessage.classList.remove('hidden');
                    statusMessage.classList.remove('text-gray-500', 'bg-gray-100');
                    statusMessage.classList.add('text-yellow-600', 'bg-yellow-100');
                    departmentProgramBarChartsContainer.classList.add('hidden');
                    departmentSlider.parentElement.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error fetching events:", error);
                statusMessage.textContent = "Error loading events. Please check your Firebase permissions.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.remove('text-gray-500', 'bg-gray-100');
                statusMessage.classList.add('text-red-600', 'bg-red-100');
            }
        };

        // --- Load and Render Data for a Specific Event ---
        const loadAndRenderData = async (eventName) => {
            if (!eventName) {
                statusMessage.textContent = "Please select an event to view.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('text-yellow-600', 'bg-yellow-100');
                return;
            }

            statusMessage.textContent = `Loading data for event "${eventName}"...`;
            statusMessage.classList.remove('hidden');
            statusMessage.classList.remove('text-yellow-600', 'bg-yellow-100');
            statusMessage.classList.add('text-gray-500', 'bg-gray-100');

            try {
                // The document reference now uses the correct full path.
                const docRef = window.firebase.doc(db, EVENTS_COLLECTION_PATH, eventName);
                const docSnap = await window.firebase.getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const rawData = JSON.parse(data.data);
                    
                    studentData = parseRawData(rawData);
                    
                    if (studentData.length > 0) {
                        statusMessage.textContent = `Data for "${eventName}" retrieved successfully!`;
                        statusMessage.classList.remove('hidden');
                        statusMessage.classList.remove('text-gray-500', 'bg-gray-100');
                        statusMessage.classList.add('text-green-600', 'bg-green-100');

                        departmentProgramBarChartsContainer.classList.remove('hidden');
                        departmentSlider.parentElement.classList.remove('hidden');

                        renderOverallBarChart(studentData);
                        initializeDepartmentSlider(studentData);
                    } else {
                        statusMessage.textContent = `Event "${eventName}" contains no valid data.`;
                        statusMessage.classList.remove('hidden');
                        statusMessage.classList.remove('text-gray-500', 'bg-gray-100');
                        statusMessage.classList.add('text-yellow-600', 'bg-yellow-100');
                        
                        departmentProgramBarChartsContainer.classList.add('hidden');
                        departmentSlider.parentElement.classList.add('hidden');
                    }
                } else {
                    statusMessage.textContent = `No data found for event "${eventName}".`;
                    statusMessage.classList.remove('hidden');
                    statusMessage.classList.remove('text-gray-500', 'bg-gray-100');
                    statusMessage.classList.add('text-yellow-600', 'bg-yellow-100');
                    
                    departmentProgramBarChartsContainer.classList.add('hidden');
                    departmentSlider.parentElement.classList.add('hidden');
                }
            } catch (e) {
                console.error("Error loading data from event:", e);
                statusMessage.textContent = "Error loading data from the cloud.";
                statusMessage.classList.remove('hidden');
                statusMessage.classList.remove('text-gray-500', 'bg-gray-100');
                statusMessage.classList.add('text-red-600', 'bg-red-100');
            }
        };

        const parseRawData = (rows) => {
            const data = [];
            if (rows.length < 2) return data;
            
            const headers = rows[0];
            const dataRows = rows.slice(1);
            
            dataRows.forEach(row => {
                if (row.length >= 15 && row[0] && row[1]) {
                    data.push({
                        department: row[0].trim(),
                        program: row[1].trim(),
                        year1: {
                            total: parseInt(row[2]) || 0,
                            present: parseInt(row[3]) || 0,
                            absent: parseInt(row[4]) || 0
                        },
                        year2: {
                            total: parseInt(row[5]) || 0,
                            present: parseInt(row[6]) || 0,
                            absent: parseInt(row[7]) || 0
                        },
                        year3: {
                            total: parseInt(row[8]) || 0,
                            present: parseInt(row[9]) || 0,
                            absent: parseInt(row[10]) || 0
                        },
                        year4: {
                            total: parseInt(row[11]) || 0,
                            present: parseInt(row[12]) || 0,
                            absent: parseInt(row[13]) || 0
                        }
                    });
                }
            });
            return data;
        };

        const initializeDepartmentSlider = (data) => {
            departments = [...new Set(data.map(row => row.department))].sort();
            
            departmentSlider.max = departments.length > 0 ? departments.length - 1 : 0;
            departmentSlider.value = 0;
            
            if (departments.length > 0) {
                const initialDepartment = departments[departmentSlider.value];
                departmentNameSpan.textContent = initialDepartment;
                renderDepartmentProgramCharts(data, initialDepartment);
                chartsPlaceholder.classList.add('hidden');
            } else {
                departmentNameSpan.textContent = "No departments found";
                departmentProgramBarChartsContainer.innerHTML = '';
                chartsPlaceholder.classList.remove('hidden');
            }

            departmentSlider.oninput = (event) => {
                const selectedIndex = parseInt(event.target.value);
                const selectedDepartment = departments[selectedIndex];
                departmentNameSpan.textContent = selectedDepartment;
                renderDepartmentProgramCharts(data, selectedDepartment);
            };
        };

        const renderDepartmentProgramCharts = (data, departmentName) => {
            currentDepartmentCharts.forEach(chart => chart.destroy());
            currentDepartmentCharts = [];
            departmentProgramBarChartsContainer.innerHTML = '';

            const deptData = data.filter(row => row.department === departmentName);

            const overallDeptPresent = deptData.reduce((sum, program) => 
                sum + program.year1.present + program.year2.present + program.year3.present + program.year4.present, 0);
            const overallDeptAbsent = deptData.reduce((sum, program) =>
                sum + program.year1.absent + program.year2.absent + program.year3.absent + program.year4.absent, 0);

            const overallDeptChartDiv = document.createElement('div');
            overallDeptChartDiv.className = 'p-4 bg-white bg-opacity-90 rounded-lg shadow-md mb-6';
            overallDeptChartDiv.innerHTML = `
                <h3 class="font-semibold text-center text-lg mb-2 text-gray-700">Overall Attendance for ${departmentName}</h3>
                <div class="chart-container">
                    <canvas id="overall-dept-chart"></canvas>
                </div>
            `;
            departmentProgramBarChartsContainer.appendChild(overallDeptChartDiv);

            const overallDeptCanvas = document.getElementById('overall-dept-chart');
            const newChart = new Chart(overallDeptCanvas, {
                type: 'bar',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        label: 'Total Students',
                        data: [overallDeptPresent, overallDeptAbsent],
                        backgroundColor: ['#2563eb', '#dc2626'],
                        borderColor: ['#1e40af', '#b91c1c'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Students'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                    return ` ${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            currentDepartmentCharts.push(newChart);
            
            deptData.forEach(program => {
                const programName = program.program;
                
                const programChartDiv = document.createElement('div');
                programChartDiv.className = 'p-4 bg-white bg-opacity-90 rounded-lg shadow-md';
                programChartDiv.innerHTML = `
                    <h3 class="font-semibold text-center text-lg mb-2 text-gray-700">Attendance for ${programName}</h3>
                    <div class="chart-container">
                        <canvas id="chart-${programName.replace(/[^a-zA-Z0-9]/g, '')}"></canvas>
                    </div>
                `;
                departmentProgramBarChartsContainer.appendChild(programChartDiv);

                const canvas = programChartDiv.querySelector('canvas');
                const newChartYear = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: ['1st Year', '2nd Year', '3rd Year', '4th Year'],
                        datasets: [{
                            label: 'Present',
                            data: [program.year1.present, program.year2.present, program.year3.present, program.year4.present],
                            backgroundColor: '#2563eb',
                            borderColor: '#1e40af',
                            borderWidth: 1
                        }, {
                            label: 'Absent',
                            data: [program.year1.absent, program.year2.absent, program.year3.absent, program.year4.absent],
                            backgroundColor: '#dc2626',
                            borderColor: '#b91c1c',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                grid: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Year Level',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Students',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: `${programName} Attendance by Year Level`,
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const datasetIndex = context.datasetIndex;
                                        const dataset = context.chart.data.datasets[datasetIndex];
                                        const otherDataset = context.chart.data.datasets[1 - datasetIndex];
                                        const total = value + otherDataset.data[context.dataIndex];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                        return ` ${context.dataset.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                currentDepartmentCharts.push(newChartYear);
            });
        };
        
        const renderOverallBarChart = (data) => {
            const overallPresent = data.reduce((sum, row) => sum + row.year1.present + row.year2.present + row.year3.present + row.year4.present, 0);
            const overallAbsent = data.reduce((sum, row) => sum + row.year1.absent + row.year2.absent + row.year3.absent + row.year4.absent, 0);

            const canvas = document.getElementById('overall-bar-chart');
            if (!canvas) return;

            if (overallBarChartInstance) {
                overallBarChartInstance.destroy();
            }

            overallBarChartInstance = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        label: 'Total Students',
                        data: [overallPresent, overallAbsent],
                        backgroundColor: ['#2563eb', '#dc2626'],
                        borderColor: ['#1e40af', '#b91c1c'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Students'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                    return `${label}${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        };
        
        eventSelector.addEventListener('change', (event) => {
            const selectedEventName = event.target.value;
            loadAndRenderData(selectedEventName);
        });

        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
        });
    </script>
</body>
</html>
