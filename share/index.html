<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data Viewer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs for Cloud Persistence -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services to the global scope
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            onSnapshot
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div class="bg-white p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-7xl flex flex-col lg:flex-row gap-8">

        <!-- Data Display and Controls Section -->
        <div class="flex-1">
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800 mb-2">Student Data Viewer</h1>
            <p class="text-gray-600 mb-6">This app retrieves student attendance data from the cloud to display charts.</p>
            
            <!-- Loading and Status Messages -->
            <div id="status-message" class="text-center p-4 text-gray-500 font-medium bg-gray-100 rounded-lg mb-6">
                Connecting to the cloud...
            </div>

            <!-- Program Selector -->
            <div id="program-controls-section" class="hidden mb-6">
                <label for="program-select" class="block text-sm font-medium text-gray-700 mb-2">Select a Program:</label>
                <select id="program-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">All Programs</option>
                </select>
            </div>

            <!-- Department Selector -->
            <div id="department-controls-section" class="hidden mb-6">
                <label for="department-select" class="block text-sm font-medium text-gray-700 mb-2">Select a Department:</label>
                <select id="department-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">All Departments</option>
                </select>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="flex-1 bg-gray-50 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Attendance by Program</h2>
            <div id="program-chart-container" class="w-full h-80 flex items-center justify-center mb-6">
                <p id="program-chart-placeholder" class="text-gray-500 text-center">Charts will appear here after data is loaded.</p>
                <canvas id="program-chart" class="hidden"></canvas>
            </div>

            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Attendance by Department</h2>
            <div id="department-chart-container" class="w-full h-80 flex items-center justify-center">
                <p id="department-chart-placeholder" class="text-gray-500 text-center">Charts will appear here after data is loaded.</p>
                <canvas id="department-chart" class="hidden"></canvas>
            </div>
        </div>

    </div>

    <script type="module">
        // --- Firebase Service Instances ---
        let db;
        let auth;
        let userId;
        const COLLECTION_NAME = "studentData";
        const DOCUMENT_ID = "mainData";

        // --- DOM Element References ---
        const programSelect = document.getElementById('program-select');
        const departmentSelect = document.getElementById('department-select');
        const statusMessage = document.getElementById('status-message');
        const programControlsSection = document.getElementById('program-controls-section');
        const departmentControlsSection = document.getElementById('department-controls-section');
        const programChartPlaceholder = document.getElementById('program-chart-placeholder');
        const departmentChartPlaceholder = document.getElementById('department-chart-placeholder');
        const programChartCanvas = document.getElementById('program-chart');
        const departmentChartCanvas = document.getElementById('department-chart');
        
        let studentData = [];
        let programChart;
        let departmentChart;

        // --- Firebase Initialization and Auth Setup ---
        const setupFirebase = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                const app = window.firebase.initializeApp(firebaseConfig);
                auth = window.firebase.getAuth(app);
                db = window.firebase.getFirestore(app);

                // Sign in with the provided custom token
                if (initialAuthToken) {
                    await window.firebase.signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await window.firebase.signInAnonymously(auth);
                }

                // Listen for auth state changes to get the user ID
                window.firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        statusMessage.textContent = "Connected to cloud. Retrieving data...";
                        statusMessage.style.color = '#4b5563';
                        fetchDataFromFirestore();
                    } else {
                        statusMessage.textContent = "Failed to connect to the cloud.";
                        statusMessage.style.color = '#dc2626';
                    }
                });
            } catch (error) {
                console.error("Firebase setup failed:", error);
                statusMessage.textContent = "Error setting up cloud connection. Please try again later.";
                statusMessage.style.color = '#dc2626';
            }
        };

        // --- Fetch Data from Firestore ---
        const fetchDataFromFirestore = () => {
            if (!db || !userId) {
                statusMessage.textContent = "Cloud connection not ready. Data cannot be retrieved.";
                statusMessage.style.color = '#dc2626';
                return;
            }

            const docRef = window.firebase.doc(db, `artifacts/${__app_id}/users/${userId}/${COLLECTION_NAME}`, DOCUMENT_ID);

            // Use onSnapshot for real-time data listening
            window.firebase.onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        studentData = JSON.parse(data.studentData);
                        if (studentData.length > 0) {
                            statusMessage.textContent = "Data retrieved successfully!";
                            statusMessage.style.color = '#10b981';
                            populateSelectors(studentData);
                            renderProgramChart(studentData);
                            renderDepartmentChart(studentData);
                        } else {
                            statusMessage.textContent = "No student data found in the cloud.";
                            statusMessage.style.color = '#dc2626';
                        }
                    } catch (e) {
                        console.error("Error parsing data from Firestore:", e);
                        statusMessage.textContent = "Error parsing data from the cloud.";
                        statusMessage.style.color = '#dc2626';
                    }
                } else {
                    statusMessage.textContent = "No data found for this user in the cloud.";
                    statusMessage.style.color = '#dc2626';
                    console.log("No such document!");
                }
            }, (error) => {
                console.error("Error fetching document:", error);
                statusMessage.textContent = "Error fetching data from the cloud. Please try again.";
                statusMessage.style.color = '#dc2626';
            });
        };

        // --- Data Formatting is not needed as we are parsing the JSON directly.
        // --- Populate Selectors ---
        const populateSelectors = (data) => {
            const uniquePrograms = new Set(data.map(item => item.program));
            programSelect.innerHTML = '<option value="">All Programs</option>';
            uniquePrograms.forEach(program => {
                const option = document.createElement('option');
                option.value = program;
                option.textContent = program;
                programSelect.appendChild(option);
            });
            programControlsSection.classList.remove('hidden');

            const uniqueDepartments = new Set(data.map(item => item.department));
            departmentSelect.innerHTML = '<option value="">All Departments</option>';
            uniqueDepartments.forEach(department => {
                const option = document.createElement('option');
                option.value = department;
                option.textContent = department;
                departmentSelect.appendChild(option);
            });
            departmentControlsSection.classList.remove('hidden');
        };

        // --- Program Chart Rendering and Updating ---
        const renderProgramChart = (data) => {
            programChartPlaceholder.classList.add('hidden');
            programChartCanvas.classList.remove('hidden');

            const labels = ['1st Year', '2nd Year', '3rd Year', '4th Year'];
            const presentData = labels.map((_, i) => data.reduce((sum, current) => sum + current[`year${i + 1}`].present, 0));
            const absentData = labels.map((_, i) => data.reduce((sum, current) => sum + current[`year${i + 1}`].absent, 0));

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Present Students',
                        data: presentData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Absent Students',
                        data: absentData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }
                ]
            };

            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const value = context.raw;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : '0.00';
                                    return `${context.dataset.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            };

            if (programChart) {
                programChart.destroy();
            }
            programChart = new Chart(programChartCanvas, config);
        };

        // --- Department Chart Rendering and Updating (Bar Chart) ---
        const renderDepartmentChart = (data) => {
            departmentChartPlaceholder.classList.add('hidden');
            departmentChartCanvas.classList.remove('hidden');

            const departmentData = data.reduce((acc, row) => {
                if (!acc[row.department]) {
                    acc[row.department] = { present: 0, absent: 0 };
                }
                acc[row.department].present += row.year1.present + row.year2.present + row.year3.present + row.year4.present;
                acc[row.department].absent += row.year1.absent + row.year2.absent + row.year3.absent + row.year4.absent;
                return acc;
            }, {});

            const labels = Object.keys(departmentData);
            const presentData = labels.map(label => departmentData[label].present);
            const absentData = labels.map(label => departmentData[label].absent);

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Present Students',
                        data: presentData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Absent Students',
                        data: absentData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }
                ]
            };

            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const value = context.raw;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : '0.00';
                                    return `${context.dataset.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            };

            if (departmentChart) {
                departmentChart.destroy();
            }
            departmentChart = new Chart(departmentChartCanvas, config);
        };

        // --- Event Listeners for Selectors ---
        programSelect.addEventListener('change', (e) => {
            const selectedProgram = e.target.value;
            let filteredData = studentData;

            if (selectedProgram !== '') {
                filteredData = studentData.filter(item => item.program === selectedProgram);
            }
            renderProgramChart(filteredData);
        });

        departmentSelect.addEventListener('change', (e) => {
            const selectedDepartment = e.target.value;
            let filteredData = studentData;

            if (selectedDepartment !== '') {
                filteredData = studentData.filter(item => item.department === selectedDepartment);
            }
            renderDepartmentChart(filteredData);
        });

        // --- Initial App Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
        });
    </script>
</body>
</html>

