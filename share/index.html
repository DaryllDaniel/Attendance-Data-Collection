<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data Viewer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs for Cloud Persistence -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services to the global scope
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            getFirestore,
            doc,
            onSnapshot
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Added background image and styling */
            background-image: url('https://scontent.fcrk1-1.fna.fbcdn.net/v/t39.30808-6/534829113_1219906786818614_3623306942044619088_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=833d8c&_nc_ohc=IVr9Yr1-pvUQ7kNvwFa9iO5&_nc_oc=AdntxIkfqY4bkAXBlJJlzddtb7L6hdtB7b9Szq2OuBkDf7fySj9CjncTopvIdlkE_aA&_nc_zt=23&_nc_ht=scontent.fcrk1-1.fna&_nc_gid=wsNnun-HKCpyMJFkIDXHpA&oh=00_AfUlrYAo7YO63AptckNhX1w5AiCyZbvdvxxE5l_uo6vsQw&oe=68AF8B73');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative; /* Needed for the overlay pseudo-element */
        }
        
        /* Blue overlay with 30% opacity */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 255, 0.3); /* Blue with 30% opacity */
            z-index: 1; /* Place below the content */
        }

        /* Fix for charts not appearing */
        .chart-container {
            position: relative;
            height: 300px; /* Explicit height for charts */
            width: 100%;
        }

        /* Styling for the top-left image */
        #top-left-logo {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 10;
            width: 100px;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <!-- Top-left logo added here -->
    <img id="top-left-logo" src="https://scontent.fcrk1-2.fna.fbcdn.net/v/t39.30808-6/481256091_1075839891225305_8701060058928039111_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=OCjjkE8jx7IQ7kNvwEp79Cp&_nc_oc=AdnDPmGq-xwFdLhQcze1O-nZmR0e5Nr8AX3fDmfdOLUPXALB4MNg7J65H2Q8TE5sY-4&_nc_zt=23&_nc_ht=scontent.fcrk1-2.fna&_nc_gid=nFjzVEKrI6WrhINW3zz39w&oh=00_AfVGG0LH9XXR_Q2o-1bm8ODj0HrJU7A7o6eu4L5YYjY7Cw&oe=68AFB084" alt="Logo">

    <!-- Separate div for title and description -->
    <div class="text-center mb-8 px-4 z-20">
        <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-2 drop-shadow-lg">Student Data Viewer</h1>
        <p class="text-gray-200 drop-shadow-md">Data retrieved successfully!</p>
    </div>

    <!-- Main Application Container -->
    <div class="bg-white bg-opacity-80 p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-7xl flex flex-col gap-8 z-20">

        <!-- Data Display and Controls Section -->
        <div class="flex-1">
            <!-- Loading and Status Messages -->
            <div id="status-message" class="text-center p-4 text-gray-500 font-medium bg-gray-100 rounded-lg mb-6 hidden">
                Connecting to the cloud...
            </div>
        </div>

        <!-- Chart Section -->
        <div class="flex-1 bg-gray-50 bg-opacity-90 p-6 rounded-xl shadow-inner w-full">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Attendance by Department and Program</h2>
            
            <!-- Overall Attendance Bar Chart -->
            <div class="p-4 bg-white bg-opacity-90 rounded-lg shadow-md mb-6 w-full">
                <h3 class="font-semibold text-center text-lg mb-2 text-gray-700">Overall Attendance Summary</h3>
                <div class="chart-container">
                    <canvas id="overall-bar-chart"></canvas>
                </div>
            </div>

            <!-- Department and Program Pie Charts Container -->
            <div id="pie-charts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full h-auto mb-6">
                <p id="pie-charts-placeholder" class="text-gray-500 text-center col-span-full">Charts will appear here after data is loaded.</p>
            </div>
            
            <!-- Program Bar Charts Container (Re-added) -->
            <div id="program-bar-charts-container" class="flex flex-col gap-8 w-full h-auto">
                <p id="program-bar-charts-placeholder" class="text-gray-500 text-center hidden">Program charts will appear here...</p>
            </div>

        </div>

    </div>

    <script type="module">
        // --- Firebase Service Instances ---
        let db;
        let auth;
        let userId;
        const COLLECTION_NAME = "studentData";
        const DOCUMENT_ID = "mainData";

        // --- DOM Element References ---
        const statusMessage = document.getElementById('status-message');
        const pieChartsContainer = document.getElementById('pie-charts-container');
        const pieChartsPlaceholder = document.getElementById('pie-charts-placeholder');
        const programBarChartsContainer = document.getElementById('program-bar-charts-container');

        let studentData = [];
        let chartInstances = {}; // Combined object to store all chart instances
        let overallBarChartInstance = null; // Instance for the overall bar chart

        // --- Firebase Initialization and Auth Setup ---
        const setupFirebase = async () => {
            try {
                // Use the Firebase config provided by the user.
                const firebaseConfig = {
                    apiKey: "AIzaSyDCRT5OxfwUD25pS6igy8v3xYlaGmMXK_0",
                    authDomain: "event-calendar-prototype-b11b6.firebaseapp.com",
                    projectId: "event-calendar-prototype-b11b6",
                    storageBucket: "event-calendar-prototype-b11b6.firebasestorage.app",
                    messagingSenderId: "532386656284",
                    appId: "1:532386656284:web:fd4533fb0f54b198752fd9",
                    measurementId: "G-J10NDCD212"
                };
                
                // Initialize the Firebase app with the hardcoded config
                const app = window.firebase.initializeApp(firebaseConfig);
                auth = window.firebase.getAuth(app);
                db = window.firebase.getFirestore(app);

                // Use anonymous sign-in, which does not require a custom token.
                await window.firebase.signInAnonymously(auth);

                // Listen for auth state changes to get the user ID
                window.firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        statusMessage.textContent = "Connected to cloud. Retrieving data...";
                        statusMessage.style.color = '#4b5563';
                        fetchDataFromFirestore();
                    } else {
                        statusMessage.textContent = "Failed to connect to the cloud.";
                        statusMessage.style.color = '#dc2626';
                    }
                });
            } catch (error) {
                console.error("Firebase setup failed:", error);
                statusMessage.textContent = "Error setting up cloud connection. Please try again later.";
                statusMessage.style.color = '#dc2626';
            }
        };

        // --- Fetch Data from Firestore ---
        const fetchDataFromFirestore = () => {
            if (!db || !userId) {
                statusMessage.textContent = "Cloud connection not ready. Data cannot be retrieved.";
                statusMessage.style.color = '#dc2626';
                return;
            }

            // Reference the correct Firestore path using the user's UID
            const docRef = window.firebase.doc(db, `artifacts/event-calendar-prototype-b11b6/users/${userId}/${COLLECTION_NAME}`, DOCUMENT_ID);

            // Use onSnapshot for real-time data listening
            window.firebase.onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        studentData = JSON.parse(data.studentData);
                        if (studentData.length > 0) {
                            statusMessage.textContent = "Data retrieved successfully!";
                            statusMessage.style.color = '#10b981';
                            renderPieCharts(studentData);
                            renderProgramBarCharts(studentData);
                            renderOverallBarChart(studentData);
                        } else {
                            statusMessage.textContent = "No student data found in the cloud.";
                            statusMessage.style.color = '#dc2626';
                        }
                    } catch (e) {
                        console.error("Error parsing data from Firestore:", e);
                        statusMessage.textContent = "Error parsing data from the cloud.";
                        statusMessage.style.color = '#dc2626';
                    }
                } else {
                    statusMessage.textContent = "No data found for this user in the cloud.";
                    statusMessage.style.color = '#dc2626';
                    console.log("No such document!");
                }
            }, (error) => {
                console.error("Error fetching document:", error);
                statusMessage.textContent = "Error fetching data from the cloud. Please try again.";
                statusMessage.style.color = '#dc2626';
            });
        };
        
        // --- Render All Pie Charts in a Row ---
        const renderPieCharts = (data) => {
            pieChartsPlaceholder.classList.add('hidden');
            pieChartsContainer.innerHTML = ''; // Clear previous charts

            // Group data by department
            const groupedByDepartment = data.reduce((acc, row) => {
                if (!acc[row.department]) {
                    acc[row.department] = { programs: [], totalPresent: 0, totalAbsent: 0 };
                }
                const totalPresent = row.year1.present + row.year2.present + row.year3.present + row.year4.present;
                const totalAbsent = row.year1.absent + row.year2.absent + row.year3.absent + row.year4.absent;
                acc[row.department].programs.push({
                    name: row.program,
                    present: totalPresent,
                    absent: totalAbsent
                });
                acc[row.department].totalPresent += totalPresent;
                acc[row.department].totalAbsent += totalAbsent;
                return acc;
            }, {});

            Object.keys(groupedByDepartment).forEach(departmentName => {
                const deptData = groupedByDepartment[departmentName];
                
                // Create pie chart for the department's overall attendance
                const deptChartDiv = document.createElement('div');
                deptChartDiv.className = 'p-4 bg-white bg-opacity-90 rounded-lg shadow-md';
                const heading = document.createElement('h3');
                heading.className = 'font-semibold text-center text-lg mb-2 text-gray-700';
                heading.textContent = departmentName;
                
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                const canvas = document.createElement('canvas');
                const canvasId = `dept-chart-${departmentName.replace(/[^a-zA-Z0-9]/g, '')}`;
                canvas.id = canvasId;
                
                chartContainer.appendChild(canvas);
                deptChartDiv.appendChild(heading);
                deptChartDiv.appendChild(chartContainer);
                pieChartsContainer.appendChild(deptChartDiv);
                updatePieChart(canvasId, deptData.totalPresent, deptData.totalAbsent);

                // If a department has multiple programs, create a program distribution pie chart
                if (deptData.programs.length > 1) {
                    const progDistChartDiv = document.createElement('div');
                    progDistChartDiv.className = 'p-4 bg-white bg-opacity-90 rounded-lg shadow-md';
                    const progDistHeading = document.createElement('h3');
                    progDistHeading.className = 'font-semibold text-center text-lg mb-2 text-gray-700';
                    progDistHeading.textContent = `${departmentName} Program Distribution`;
                    
                    const progDistChartContainer = document.createElement('div');
                    progDistChartContainer.className = 'chart-container';
                    const progDistCanvas = document.createElement('canvas');
                    const progDistCanvasId = `prog-dist-chart-${departmentName.replace(/[^a-zA-Z0-9]/g, '')}`;
                    progDistCanvas.id = progDistCanvasId;
                    
                    progDistChartContainer.appendChild(progDistCanvas);
                    progDistChartDiv.appendChild(progDistHeading);
                    progDistChartDiv.appendChild(progDistChartContainer);
                    pieChartsContainer.appendChild(progDistChartDiv);
                    
                    const programLabels = deptData.programs.map(p => p.name);
                    const programData = deptData.programs.map(p => p.present + p.absent);
                    updateProgramDistributionPieChart(progDistCanvasId, programLabels, programData);
                }
            });
        };
        
        // --- Helper function to create/update a pie chart ---
        const updatePieChart = (canvasId, presentCount, absentCount) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas element with ID '${canvasId}' not found.`);
                return;
            }

            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }

            const chart = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        data: [presentCount, absentCount],
                        backgroundColor: ['#2563eb', '#dc2626'],
                        hoverOffset: 8,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const value = tooltipItem.raw;
                                    const total = tooltipItem.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                    return ` ${tooltipItem.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '40%', // Create a donut chart
                }
            });
            chartInstances[canvasId] = chart;
        };

        // --- New Helper function for program distribution pie chart ---
        const updateProgramDistributionPieChart = (canvasId, labels, data) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas element with ID '${canvasId}' not found.`);
                return;
            }

            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }

            const chart = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#f59e0b', '#10b981', '#6366f1', '#ef4444', '#3b82f6', '#ec4899', '#a855f7'],
                        hoverOffset: 8,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const value = tooltipItem.raw;
                                    const total = tooltipItem.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                    return ` ${tooltipItem.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '40%',
                }
            });

            chartInstances[canvasId] = chart;
        };


        // --- Render Program Bar Charts and Multi-Program Pie Charts ---
        const renderProgramBarCharts = (data) => {
            programBarChartsContainer.innerHTML = ''; // Clear previous charts
            
            // Group data by department
            const groupedData = data.reduce((acc, row) => {
                if (!acc[row.department]) {
                    acc[row.department] = [];
                }
                const totalPresent = row.year1.present + row.year2.present + row.year3.present + row.year4.present;
                const totalAbsent = row.year1.absent + row.year2.absent + row.year3.absent + row.year4.absent;
                const total = totalPresent + totalAbsent;
                acc[row.department].push({
                    program: row.program,
                    present: totalPresent,
                    absent: totalAbsent,
                    total: total
                });
                return acc;
            }, {});
            
            // Loop through each department and its programs
            Object.keys(groupedData).forEach(departmentName => {
                const departmentPrograms = groupedData[departmentName];
                const deptProgramsDiv = document.createElement('div');
                deptProgramsDiv.className = 'p-4 bg-white bg-opacity-90 rounded-lg shadow-md w-full';

                const deptTitle = document.createElement('h3');
                deptTitle.className = 'font-bold text-xl text-blue-800 mb-4 text-center';
                deptTitle.textContent = `${departmentName} Programs`;
                deptProgramsDiv.appendChild(deptTitle);

                const programChartGrid = document.createElement('div');
                programChartGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';
                
                departmentPrograms.forEach(program => {
                    const programChartDiv = document.createElement('div');
                    programChartDiv.className = 'p-4 bg-gray-50 bg-opacity-90 rounded-lg shadow-sm';
                    
                    const heading = document.createElement('h4');
                    heading.className = 'font-semibold text-center text-md mb-2 text-gray-700';
                    heading.textContent = program.program;
                    
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'chart-container';
                    const canvas = document.createElement('canvas');
                    canvas.id = `prog-bar-chart-${program.program.replace(/[^a-zA-Z0-9]/g, '')}`;
                    
                    chartContainer.appendChild(canvas);
                    programChartDiv.appendChild(heading);
                    programChartDiv.appendChild(chartContainer);
                    programChartGrid.appendChild(programChartDiv);

                    updateProgramBarChart(canvas.id, program.present, program.absent, program.total);
                });

                deptProgramsDiv.appendChild(programChartGrid);
                programBarChartsContainer.appendChild(deptProgramsDiv);
            });
        };
        
        // --- Helper function to create/update a bar chart with percentages ---
        const updateProgramBarChart = (canvasId, presentCount, absentCount, totalCount) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas element with ID '${canvasId}' not found.`);
                return;
            }

            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }

            const chart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: ['Present', 'Absent', 'Total'],
                    datasets: [{
                        label: 'Attendance',
                        data: [presentCount, absentCount, totalCount],
                        backgroundColor: ['#2563eb', '#dc2626', '#16a34a'],
                        borderColor: ['#1e40af', '#b91c1c', '#15803d'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Students'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = (value / total) * 100;
                                    return `${label}${value}`;
                                }
                            }
                        }
                    }
                }
            });

            chartInstances[canvasId] = chart;
        };

        // --- Render Overall Bar Chart with Percentages ---
        const renderOverallBarChart = (data) => {
            const overallPresent = data.reduce((sum, row) => sum + row.year1.present + row.year2.present + row.year3.present + row.year4.present, 0);
            const overallAbsent = data.reduce((sum, row) => sum + row.year1.absent + row.year2.absent + row.year3.absent + row.year4.absent, 0);

            const canvas = document.getElementById('overall-bar-chart');
            if (!canvas) return;

            if (overallBarChartInstance) {
                overallBarChartInstance.destroy();
            }

            overallBarChartInstance = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        label: 'Total Students',
                        data: [overallPresent, overallAbsent],
                        backgroundColor: ['#2563eb', '#dc2626'],
                        borderColor: ['#1e40af', '#b91c1c'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Students'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                    return `${label}${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        };
        
        // --- Initial App Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
        });
    </script>
</body>
</html>
