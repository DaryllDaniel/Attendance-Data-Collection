<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for creating the pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom modal animation */
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Main Application Container -->
    <div class="bg-white p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-2xl transform transition-transform duration-300 hover:scale-105">
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-blue-800 mb-6">Student Data Input</h1>
        <p class="text-center text-gray-600 mb-8">Enter the student data below and visualize it with a pie chart or export it as a CSV file.</p>

        <!-- Input Form -->
        <div class="space-y-6">
            <!-- Department and Program fields -->
            <div>
                <label for="department" class="block text-sm font-semibold text-gray-700">Department</label>
                <input type="text" id="department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-3 bg-gray-50" placeholder="e.g., College of Engineering">
            </div>
            <div>
                <label for="program" class="block text-sm font-semibold text-gray-700">Program</label>
                <input type="text" id="program" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-3 bg-gray-50" placeholder="e.g., Computer Science">
            </div>

            <!-- Student Data for each year level -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- 1st Year Students -->
                <div class="p-4 bg-blue-50 rounded-lg shadow-sm">
                    <h3 class="font-bold text-blue-600 mb-2">1st Year Students</h3>
                    <label class="block text-xs font-medium text-gray-500">Total</label>
                    <input type="number" id="year1_total" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Present</label>
                    <input type="number" id="year1_present" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Absent</label>
                    <input type="number" id="year1_absent" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                </div>
                <!-- 2nd Year Students -->
                <div class="p-4 bg-green-50 rounded-lg shadow-sm">
                    <h3 class="font-bold text-green-600 mb-2">2nd Year Students</h3>
                    <label class="block text-xs font-medium text-gray-500">Total</label>
                    <input type="number" id="year2_total" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Present</label>
                    <input type="number" id="year2_present" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Absent</label>
                    <input type="number" id="year2_absent" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                </div>
                <!-- 3rd Year Students -->
                <div class="p-4 bg-yellow-50 rounded-lg shadow-sm">
                    <h3 class="font-bold text-yellow-600 mb-2">3rd Year Students</h3>
                    <label class="block text-xs font-medium text-gray-500">Total</label>
                    <input type="number" id="year3_total" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Present</label>
                    <input type="number" id="year3_present" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Absent</label>
                    <input type="number" id="year3_absent" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                </div>
                <!-- 4th Year Students -->
                <div class="p-4 bg-purple-50 rounded-lg shadow-sm">
                    <h3 class="font-bold text-purple-600 mb-2">4th Year Students</h3>
                    <label class="block text-xs font-medium text-gray-500">Total</label>
                    <input type="number" id="year4_total" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Present</label>
                    <input type="number" id="year4_present" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Absent</label>
                    <input type="number" id="year4_absent" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                </div>
            </div>
        </div>

        <!-- Validation Message Box -->
        <div id="validationMessage" class="mt-6 p-4 text-center text-red-700 bg-red-100 rounded-lg border border-red-300 hidden">
            Please fill in all the required fields.
        </div>

        <!-- Buttons -->
        <div class="mt-8 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="showDataBtn" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 font-bold">Show Pie Chart</button>
            <button id="exportCsvBtn" class="w-full sm:w-auto px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 font-bold">Export to CSV</button>
        </div>
    </div>

    <!-- Pie Chart Modal (initially hidden) -->
    <div id="chartModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-lg relative">
            <h2 id="chartTitle" class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-4">Attendance Overview</h2>
            <div class="w-full">
                <canvas id="myPieChart"></canvas>
            </div>
            <p class="text-sm text-center text-gray-500 mt-4">Present vs. Absent Student Count</p>
            <!-- Close Button -->
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const showDataBtn = document.getElementById('showDataBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const chartModal = document.getElementById('chartModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const chartCanvas = document.getElementById('myPieChart');
        const validationMessage = document.getElementById('validationMessage');
        let myPieChart = null; // Variable to hold the chart instance

        // --- Helper Function to get data from inputs ---
        const getStudentData = () => {
            const getVal = (id) => parseInt(document.getElementById(id).value) || 0;
            const department = document.getElementById('department').value;
            const program = document.getElementById('program').value;

            return {
                department,
                program,
                year1: { total: getVal('year1_total'), present: getVal('year1_present'), absent: getVal('year1_absent') },
                year2: { total: getVal('year2_total'), present: getVal('year2_present'), absent: getVal('year2_absent') },
                year3: { total: getVal('year3_total'), present: getVal('year3_present'), absent: getVal('year3_absent') },
                year4: { total: getVal('year4_total'), present: getVal('year4_present'), absent: getVal('year4_absent') }
            };
        };

        // --- Show Pie Chart Functionality ---
        const showPieChart = () => {
            // First, get all the inputs to validate
            const textInputs = ['department', 'program'];
            const numberInputs = [
                'year1_total', 'year1_present', 'year1_absent',
                'year2_total', 'year2_present', 'year2_absent',
                'year3_total', 'year3_present', 'year3_absent',
                'year4_total', 'year4_present', 'year4_absent'
            ];

            let firstInvalidInput = null;
            let isValid = true;

            // Clear previous validation highlights
            [...textInputs, ...numberInputs].forEach(id => {
                const input = document.getElementById(id);
                input.classList.remove('border-red-500');
            });

            // Validate text inputs
            textInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input.value.trim() === '') {
                    input.classList.add('border-red-500');
                    if (!firstInvalidInput) firstInvalidInput = input;
                    isValid = false;
                }
            });

            // Validate number inputs
            numberInputs.forEach(id => {
                const input = document.getElementById(id);
                // The input.value for number fields defaults to '0' on first load, so we check if it's explicitly an empty string
                if (input.value.trim() === '' || parseInt(input.value) < 0) {
                    input.classList.add('border-red-500');
                    if (!firstInvalidInput) firstInvalidInput = input;
                    isValid = false;
                }
            });

            if (!isValid) {
                validationMessage.classList.remove('hidden');
                if (firstInvalidInput) {
                    firstInvalidInput.focus();
                }
                return; // Stop execution if validation fails
            }

            // Hide validation message if everything is valid
            validationMessage.classList.add('hidden');

            const data = getStudentData();
            const totalPresent = data.year1.present + data.year2.present + data.year3.present + data.year4.present;
            const totalAbsent = data.year1.absent + data.year2.absent + data.year3.absent + data.year4.absent;

            if (myPieChart) {
                myPieChart.destroy(); // Destroy previous chart instance
            }

            // Create new chart instance
            myPieChart = new Chart(chartCanvas, {
                type: 'pie',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        data: [totalPresent, totalAbsent],
                        backgroundColor: ['#2563eb', '#dc2626'],
                        hoverOffset: 8,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const value = tooltipItem.raw;
                                    const total = tooltipItem.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                    return ` ${tooltipItem.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '40%', // Create a donut chart
                }
            });

            chartModal.classList.remove('hidden'); // Show the modal
        };

        // --- Export to CSV Functionality ---
        const exportToCsv = () => {
            const data = getStudentData();
            const headers = [
                'Department', 'Program',
                '1st Year Total', '1st Year Present', '1st Year Absent',
                '2nd Year Total', '2nd Year Present', '2nd Year Absent',
                '3rd Year Total', '3rd Year Present', '3rd Year Absent',
                '4th Year Total', '4th Year Present', '4th Year Absent'
            ];
            const values = [
                data.department || 'N/A', data.program || 'N/A',
                data.year1.total, data.year1.present, data.year1.absent,
                data.year2.total, data.year2.present, data.year2.absent,
                data.year3.total, data.year3.present, data.year3.absent,
                data.year4.total, data.year4.present, data.year4.absent
            ];

            // Format data into CSV string
            const csvContent = headers.join(',') + '\n' + values.join(',');

            // Create a Blob and a temporary link to trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'student_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Free up the object URL
            } else {
                alert('Your browser does not support downloading CSV files directly.');
            }
        };

        // --- Event Listeners ---
        showDataBtn.addEventListener('click', showPieChart);
        exportCsvBtn.addEventListener('click', exportToCsv);
        closeModalBtn.addEventListener('click', () => {
            chartModal.classList.add('hidden');
        });

        // Close modal when clicking outside of it
        chartModal.addEventListener('click', (event) => {
            if (event.target === chartModal) {
                chartModal.classList.add('hidden');
            }
        });

        // Close modal with the Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                chartModal.classList.add('hidden');
            }
        });
    </script>

</body>
</html>
