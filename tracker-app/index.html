<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for creating the pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container: Now a flex container for two sections -->
    <div class="bg-white p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-7xl flex flex-col md:flex-row gap-8">

        <!-- Input Form Section (Left Side) -->
        <div class="w-full md:w-1/2 space-y-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center md:text-left text-blue-800 mb-6">Student Data Input</h1>
            <p class="text-center md:text-left text-gray-600 mb-8">Enter the student data below to see the attendance charts update in real-time or export the data as a CSV file.</p>

            <!-- Department and Program fields -->
            <div>
                <label for="department" class="block text-sm font-semibold text-gray-700">Department</label>
                <input type="text" id="department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-3 bg-gray-50" placeholder="e.g., College of Engineering">
            </div>
            <div>
                <label for="program" class="block text-sm font-semibold text-gray-700">Program</label>
                <input type="text" id="program" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-3 bg-gray-50" placeholder="e.g., Computer Science">
            </div>

            <!-- Student Data for each year level -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6">
                <!-- 1st Year Students -->
                <div class="p-4 bg-blue-50 rounded-lg shadow-sm">
                    <h3 class="font-bold text-blue-600 mb-2">1st Year Students</h3>
                    <label class="block text-xs font-medium text-gray-500">Total</label>
                    <input type="number" id="year1_total" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Present</label>
                    <input type="number" id="year1_present" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Absent</label>
                    <input type="number" id="year1_absent" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                </div>
                <!-- 2nd Year Students -->
                <div class="p-4 bg-green-50 rounded-lg shadow-sm">
                    <h3 class="font-bold text-green-600 mb-2">2nd Year Students</h3>
                    <label class="block text-xs font-medium text-gray-500">Total</label>
                    <input type="number" id="year2_total" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Present</label>
                    <input type="number" id="year2_present" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Absent</label>
                    <input type="number" id="year2_absent" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                </div>
                <!-- 3rd Year Students -->
                <div class="p-4 bg-yellow-50 rounded-lg shadow-sm">
                    <h3 class="font-bold text-yellow-600 mb-2">3rd Year Students</h3>
                    <label class="block text-xs font-medium text-gray-500">Total</label>
                    <input type="number" id="year3_total" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Present</label>
                    <input type="number" id="year3_present" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Absent</label>
                    <input type="number" id="year3_absent" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                </div>
                <!-- 4th Year Students -->
                <div class="p-4 bg-purple-50 rounded-lg shadow-sm">
                    <h3 class="font-bold text-purple-600 mb-2">4th Year Students</h3>
                    <label class="block text-xs font-medium text-gray-500">Total</label>
                    <input type="number" id="year4_total" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Present</label>
                    <input type="number" id="year4_present" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                    <label class="block text-xs font-medium text-gray-500 mt-2">Absent</label>
                    <input type="number" id="year4_absent" class="mt-1 block w-full rounded-md border-gray-300 p-2 text-sm" value="0">
                </div>
            </div>

            <!-- Export Button -->
            <div class="mt-8 flex justify-center">
                <button id="exportCsvBtn" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 font-bold">Export to CSV</button>
            </div>
        </div>

        <!-- Real-time Chart Display Section (Right Side) -->
        <div class="w-full md:w-1/2 flex flex-col justify-center items-center p-4 bg-gray-50 rounded-xl shadow-inner">
            <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-4">Live Attendance Charts</h2>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 w-full max-w-xl">
                <!-- Overall Chart -->
                <div class="col-span-1 sm:col-span-2 p-4 bg-white rounded-lg shadow-md">
                    <h3 class="font-semibold text-center text-lg mb-2 text-gray-700">Overall Attendance</h3>
                    <div class="w-full h-auto max-w-xs mx-auto">
                        <canvas id="myPieChart"></canvas>
                    </div>
                </div>
                <!-- 1st Year Chart -->
                <div class="p-4 bg-white rounded-lg shadow-md">
                    <h3 class="font-semibold text-center text-lg mb-2 text-blue-600">1st Year</h3>
                    <div class="w-full h-auto max-w-[150px] mx-auto">
                        <canvas id="year1PieChart"></canvas>
                    </div>
                </div>
                <!-- 2nd Year Chart -->
                <div class="p-4 bg-white rounded-lg shadow-md">
                    <h3 class="font-semibold text-center text-lg mb-2 text-green-600">2nd Year</h3>
                    <div class="w-full h-auto max-w-[150px] mx-auto">
                        <canvas id="year2PieChart"></canvas>
                    </div>
                </div>
                <!-- 3rd Year Chart -->
                <div class="p-4 bg-white rounded-lg shadow-md">
                    <h3 class="font-semibold text-center text-lg mb-2 text-yellow-600">3rd Year</h3>
                    <div class="w-full h-auto max-w-[150px] mx-auto">
                        <canvas id="year3PieChart"></canvas>
                    </div>
                </div>
                <!-- 4th Year Chart -->
                <div class="p-4 bg-white rounded-lg shadow-md">
                    <h3 class="font-semibold text-center text-lg mb-2 text-purple-600">4th Year</h3>
                    <div class="w-full h-auto max-w-[150px] mx-auto">
                        <canvas id="year4PieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const chartInstances = {}; // Object to store all chart instances

        // --- Helper Function to get data from inputs ---
        const getStudentData = () => {
            const getVal = (id) => parseInt(document.getElementById(id).value) || 0;
            const department = document.getElementById('department').value;
            const program = document.getElementById('program').value;

            return {
                department,
                program,
                year1: { total: getVal('year1_total'), present: getVal('year1_present'), absent: getVal('year1_absent') },
                year2: { total: getVal('year2_total'), present: getVal('year2_present'), absent: getVal('year2_absent') },
                year3: { total: getVal('year3_total'), present: getVal('year3_present'), absent: getVal('year3_absent') },
                year4: { total: getVal('year4_total'), present: getVal('year4_present'), absent: getVal('year4_absent') }
            };
        };

        // --- Helper function to create/update a pie chart ---
        const updatePieChart = (canvasId, presentCount, absentCount) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas element with ID '${canvasId}' not found.`);
                return;
            }

            // Destroy previous chart instance if it exists to prevent memory leaks
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }

            const chart = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        data: [presentCount, absentCount],
                        backgroundColor: ['#2563eb', '#dc2626'],
                        hoverOffset: 8,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const value = tooltipItem.raw;
                                    const total = tooltipItem.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                    return ` ${tooltipItem.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '40%', // Create a donut chart
                }
            });

            chartInstances[canvasId] = chart;
        };

        // --- Function to update all charts with current data ---
        const updateAllCharts = () => {
            const data = getStudentData();
            const totalPresent = data.year1.present + data.year2.present + data.year3.present + data.year4.present;
            const totalAbsent = data.year1.absent + data.year2.absent + data.year3.absent + data.year4.absent;

            updatePieChart('myPieChart', totalPresent, totalAbsent);
            updatePieChart('year1PieChart', data.year1.present, data.year1.absent);
            updatePieChart('year2PieChart', data.year2.present, data.year2.absent);
            updatePieChart('year3PieChart', data.year3.present, data.year3.absent);
            updatePieChart('year4PieChart', data.year4.present, data.year4.absent);
        };

        // --- Export to CSV Functionality ---
        const exportToCsv = () => {
            const data = getStudentData();
            const headers = [
                'Department', 'Program',
                '1st Year Total', '1st Year Present', '1st Year Absent',
                '2nd Year Total', '2nd Year Present', '2nd Year Absent',
                '3rd Year Total', '3rd Year Present', '3rd Year Absent',
                '4th Year Total', '4th Year Present', '4th Year Absent'
            ];
            const values = [
                data.department || 'N/A', data.program || 'N/A',
                data.year1.total, data.year1.present, data.year1.absent,
                data.year2.total, data.year2.present, data.year2.absent,
                data.year3.total, data.year3.present, data.year3.absent,
                data.year4.total, data.year4.present, data.year4.absent
            ];

            // Format data into CSV string
            const csvContent = headers.join(',') + '\n' + values.join(',');

            // Create a Blob and a temporary link to trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'student_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Free up the object URL
            } else {
                // Using an alternative message box instead of alert()
                const messageBox = document.createElement('div');
                messageBox.textContent = 'Your browser does not support downloading CSV files directly.';
                messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;';
                document.body.appendChild(messageBox);
                setTimeout(() => document.body.removeChild(messageBox), 3000);
            }
        };

        // --- Event Listeners ---
        // Listen for 'input' events on all number fields to trigger real-time updates
        const numberInputs = document.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            input.addEventListener('input', updateAllCharts);
        });

        exportCsvBtn.addEventListener('click', exportToCsv);

        // Initial chart render on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateAllCharts();
        });
    </script>
</body>
</html>
